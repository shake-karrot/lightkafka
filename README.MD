# LightKafka

## 개요

LightKafka는 경량화된 Kafka 스타일의 메시지 브로커 구현입니다.

## 주요 컴포넌트

### Record (`internal/record`)

**역할**: 가장 기초가 되는 도우미 패키지입니다. 메시지 레코드의 구조와 직렬화/역직렬화를 담당합니다.

#### 주요 기능

- **레코드 구조 정의**
  - `Record`: Offset, Timestamp, Key, Value를 포함하는 메시지 레코드
  - `Header`: 레코드의 메타데이터 (TotalSize, Offset, CRC, Timestamp, KeySize, ValueSize)

- **직렬화 (MarshalTo)**
  - 레코드를 바이너리 형식으로 변환하여 버퍼에 작성
  - CRC32 체크섬을 계산하여 데이터 무결성 보장
  - Little Endian 바이트 순서 사용

- **역직렬화 (UnmarshalInto, UnmarshalHeader)**
  - 바이너리 데이터에서 레코드로 변환
  - Zero-copy 구현: 슬라이스 참조를 사용하여 실제 데이터 복사 없이 읽기
  - CRC 검증을 통한 데이터 무결성 확인

#### 특징

- **순수한 변환 로직**: 파일이나 락(Lock)에 대해 전혀 모릅니다. 오직 "바이트 ↔ 구조체" 변환만 담당합니다.
- Zero-allocation 설계: Header는 값 타입으로 스택에 할당
- Zero-copy 읽기: 슬라이스 참조를 통한 효율적인 메모리 사용
- CRC 체크섬을 통한 데이터 검증

---

### Store - Segment (`internal/store`)

**역할**: `record` 패키지를 사용하여 파일 하나(segment)를 Mmap으로 열고, 레코드를 쓰고 읽는 물리적 작업을 담당합니다.

#### 주요 기능

- **세그먼트 관리**
  - 하나의 디스크 파일을 하나의 세그먼트로 관리
  - mmap(Memory-mapped I/O)을 사용하여 파일을 메모리에 매핑
  - 고정 크기 파일을 미리 할당하여 성능 최적화

- **레코드 쓰기 (Append)**
  - `record` 패키지를 사용하여 레코드를 세그먼트에 추가
  - 자동으로 Offset 할당 및 관리
  - 세그먼트가 가득 찬 경우 에러 반환

- **레코드 읽기 (ReadWithPosition)**
  - 지정된 위치에서 레코드 읽기
  - 다음 레코드의 위치를 반환하여 순차 읽기 지원
  - 손상된 레코드 감지 및 에러 처리

- **복구 (Recover)**
  - 세그먼트 초기화 시 기존 레코드 복구
  - 손상된 레코드 위치를 찾아 writePos 설정
  - 다음 Offset을 올바르게 설정하여 중복 방지

- **동기화 (Sync)**
  - msync 시스템 콜을 사용하여 메모리 매핑된 데이터를 디스크에 동기화
  - 데이터 영속성 보장

#### 특징

- **Thread-Safe 하지 않음**: 락(Lock)이 없습니다. 동시성 제어는 상위 레이어에서 처리해야 합니다.
- mmap을 통한 고성능 I/O
- 고정 크기 세그먼트로 예측 가능한 성능
- 재시작 시 자동 복구 기능
- BaseOffset과 NextOffset을 통한 레코드 추적

---

## 아키텍처

```
┌─────────────┐
│   Record    │  ← 메시지 레코드 구조 및 직렬화/역직렬화
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Segment   │  ← 디스크 파일 관리 (mmap 기반)
└─────────────┘
```

`record`는 순수한 바이트 변환 로직만 담당하는 기초 도우미 패키지이고, `store`는 `record`를 사용하여 실제 파일 I/O 작업을 수행합니다.

